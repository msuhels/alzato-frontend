API SPECIFICATION (foreign-education-be)

Base
- Base URL: /api
- Auth: Bearer JWT in Authorization: Bearer <token>
- Content-Type: application/json
- Common pagination: limit (1–200, default 50), offset (0+, default 0)
- Standard error shape:
{ "error": "Message", "code": "ERROR_CODE", "details": [] }

Auth
POST /api/auth/signin  (public)
- Body:
{ "email": "user@example.com", "password": "secret" }
- 200:
{ "token": "jwt-token-string", "user": { "id": "uuid", "email": "user@example.com", "role": "user" } }

POST /api/auth/reset-password  (requires Authorization)
- Body:
{ "email": "user@example.com" }
- 200:
{ "success": true }

GET /api/auth/verify-email/:token  (requires Authorization)
- 200:
{ "success": true }

POST /api/auth/refresh-token  (requires Authorization)
- Body:
{ "refreshToken": "..." }
- 200:
{ "token": "new-access-token" }

POST /api/auth/signout  (requires Authorization)
- 200:
{ "success": true }

GET /api/auth/me  (requires Authorization)
- 200: current user object

PUT /api/auth/profile  (requires Authorization)
- Body (any subset):
{ "firstName": "", "lastName": "", "phone": "", "bio": "" }
- 200: updated profile

PUT /api/auth/change-password  (requires Authorization)
- Body:
{ "newPassword": "secret" }
- 200:
{ "success": true }

Users (all require auth; admin where noted)
GET /api/user/profile
- 200:
{ "id": "uuid", "email": "user@example.com", "firstName": "", "lastName": "", "phone": "", "bio": "", "avatar": "", "role": "user" }

PUT /api/user/profile
- Body (any subset):
{ "firstName": "", "lastName": "", "phone": "", "bio": "", "avatar": "" }
- 200: updated profile (same shape as GET)

GET /api/user/all  (admin)
- 200:
[ { "id": "uuid", "email": "x@x.com", "role": "user", "firstName": "", "lastName": "" } ]

GET /api/user/stats  (admin)
- 200:
{ "totalUsers": 0, "byRole": { "admin": 1, "moderator": 2, "user": 10 } }

GET /api/user/:userId  (admin)
- 200: user object

PUT /api/user/:userId/role  (admin)
- Body:
{ "role": "user|moderator|admin" }
- 200: updated user

DELETE /api/user/:userId  (admin)
- 200:
{ "success": true }

POST /api/user/admin/create  (admin)
- Body:
{ "email": "x@x.com", "password": "secret", "role": "user", "firstName": "", "lastName": "" }
- 201: created user object

Students (all require auth)
GET /api/students
- Query:
  - Pagination: limit, offset
  - Sorting: sort_by in id|created_at|name|email|intake_year, sort_dir in asc|desc
  - Filters (optional): name, email, phone, category, zone, source_of_student
  - Date ranges: intake_year_from, intake_year_to, created_from, created_to (ISO8601)
  - Search: q (matches name/email/phone)
- 200:
{ "success": true, "items": [ { "id": 1, "name": "", "email": "", "phone": "", "category": "", "zone": "", "source_of_student": "", "intake_year": "2025-01-01", "created_at": "2025-01-01T00:00:00Z" } ], "total": 0, "limit": 50, "offset": 0 }

GET /api/students/:id
- 200:
{ "success": true, "student": { "...": "..." } }

POST /api/students
- Body (minimally name; others optional):
{ "name": "John", "email": "john@x.com", "phone": "123", "intake_year": "2025-01-01", "password": "optional", "category": "", "zone": "", "source_of_student": "", "associate_wise_installments": "" }
- 201:
{ "success": true, "student": { "...created..." } }

PUT /api/students/:id
- Body: any updatable fields (same keys as POST, all optional)
- 200:
{ "success": true, "student": { "...updated..." } }

DELETE /api/students/:id
- 200:
{ "success": true, "message": "Student deleted" }

POST /api/students/bulk-delete
- Body:
{ "ids": [1, 2, 3] }
- 200:
{ "success": true, "deleted": 3 }

Payments (all require auth)
GET /api/payments
- Query:
  - Pagination: limit, offset
  - Sorting: sort_by in id|created_at|installment_date|amount|student_id, sort_dir in asc|desc
  - Filters (optional):
    - student_id (int)
    - payment_type (text)
    - payment_recieved_in (text)
    - Date ranges: created_from, created_to, installment_from, installment_to (ISO8601)
    - Amount ranges: min_amount, max_amount
- 200:
{ "success": true, "items": [ { "id": 1, "created_at": "2025-10-13T00:00:00Z", "student_id": 123, "installment_date": "2025-10-13", "amount": 500.75, "payment_recieved_in": "bank", "payment_type": "cash", "remarks": "First", "purpose": "Tuition", "ak_approval": "pending", "ak_remarks": "N/A" } ], "total": 0, "limit": 50, "offset": 0 }

POST /api/payments
- Body:
{
  "student_id": 123,
  "installment_date": "2025-10-13",
  "amount": 500.75,
  "payment_recieved_in": "bank",
  "payment_type": "cash",
  "remarks": "First installment",
  "purpose": "Tuition",
  "ak_approval": "pending",
  "ak_remarks": "N/A"
}
- 201:
{ "success": true, "payment": { "...created..." } }

Quick cURL examples
- Login:
curl -X POST "$BASE/api/auth/signin" -H "Content-Type: application/json" -d '{"email":"admin@x.com","password":"secret"}'

- List students:
curl "$BASE/api/students?limit=20&offset=0&q=john" -H "Authorization: Bearer $TOKEN"

- Create student:
curl -X POST "$BASE/api/students" -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d '{"name":"John Doe","email":"john@x.com"}'

- List payments for a student in 2025:
curl "$BASE/api/payments?student_id=123&created_from=2025-01-01&created_to=2025-12-31" -H "Authorization: Bearer $TOKEN"

- Create payment:
curl -X POST "$BASE/api/payments" -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d '{"student_id":123,"amount":500.75,"installment_date":"2025-10-13"}'

Dashboard (all require auth)
GET /api/dashboard
- Query (all optional):
  - from, to: ISO8601 date-time range for payments.installment_date and students.created_at
  - zone: filter students by zone and restrict payments to those students
  - category: filter students by category and restrict payments to those students
  - recent_payments_limit: 1–100 (default 10)
- 200:
{
  "success": true,
  "totals": {
    "totalRevenue": 0,
    "totalStudents": 0,
    "revenueThisMonth": 0,
    "newStudentsThisMonth": 0
  },
  "charts": {
    "monthlyRevenue": [ { "month": "2025-05", "amount": 0 } ],
    "studentsByZone": { "North": 10, "South": 5 },
    "revenueByZone": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } }
  },
  "tables": {
    "recentPayments": [ { "id": 1, "student_id": 123, "amount": 500.75, "date": "2025-10-13T00:00:00Z", "payment_type": "cash" } ]
  }
}

Notes:
- "monthlyRevenue" always returns last 12 months keyed as YYYY-MM of payment installment_date.
- When filtering by zone/category, payments are limited to matching students.
- "newStudentsThisMonth" counts students created in the current calendar month.

Examples:
- Basic: curl "$BASE/api/dashboard" -H "Authorization: Bearer $TOKEN"
- Date range: curl "$BASE/api/dashboard?from=2025-01-01&to=2025-12-31" -H "Authorization: Bearer $TOKEN"
- Zone filter: curl "$BASE/api/dashboard?zone=North&recent_payments_limit=5" -H "Authorization: Bearer $TOKEN"

<<<<<<< HEAD
GET /api/dashboard/revenue/monthly-series  (requires Authorization)
- Query (optional):
  - months: 1–24 (default 6)
  - zone: filter students by zone and restrict payments to those students
  - category: filter students by category and restrict payments to those students
- 200:
{
  "success": true,
  "months": 6,
  "items": [
    { "month": "2025-06", "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "totalStudents": 0 }
  ]
}


GET /api/dashboard/net-revenue/total  (requires Authorization)
- Query (optional):
  - from, to: ISO8601 date-time range applied to payments.installment_date and students.created_at
  - zone: filter students by zone and restrict payments to those students
  - category: filter students by category and restrict payments to those students
- 200:
{
  "success": true,
  "totalRevenue": 0,
  "totalPayout": 0,
  "netRevenue": 0,
  "totalStudents": 0,
  "zoneWise": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } }
}

GET /api/dashboard/net-revenue/year/current  (requires Authorization)
- Query (optional): zone, category
- 200:
{
  "success": true,
  "period": { "from": "2025-01-01T00:00:00.000Z", "to": "2026-01-01T00:00:00.000Z" },
  "totalRevenue": 0,
  "totalPayout": 0,
  "netRevenue": 0,
  "totalStudents": 0,             // students created this calendar year
  "zoneWise": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } },
  "lastPeriod": {
    "totalRevenue": 0,            // last calendar year
    "totalPayout": 0,
    "netRevenue": 0,
    "totalStudents": 0,
    "zoneWise": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } }
  }
}

GET /api/dashboard/net-revenue/month/current  (requires Authorization)
- Query (optional): zone, category
- 200:
{
  "success": true,
  "period": { "from": "2025-10-01T00:00:00.000Z", "to": "2025-11-01T00:00:00.000Z" },
  "totalRevenue": 0,
  "totalPayout": 0,
  "netRevenue": 0,
  "totalStudents": 0,             // students created this calendar month
  "zoneWise": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } },
  "lastPeriod": {
    "totalRevenue": 0,            // previous calendar month
    "totalPayout": 0,
    "netRevenue": 0,
    "totalStudents": 0,
    "zoneWise": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } }
  }
}

POST /api/dashboard/revenue/monthly  (requires Authorization)
- Body:
{ "month": "YYYY-MM", "zone": "optional", "category": "optional" }
- 200:
{
  "success": true,
  "period": { "month": "2025-10", "from": "2025-10-01T00:00:00.000Z", "to": "2025-11-01T00:00:00.000Z" },
  "totalRevenue": 0,
  "totalPayout": 0,
  "netRevenue": 0,
  "totalStudents": 0,             // students created in that month
  "zoneWise": { "North": { "totalRevenue": 0, "totalPayout": 0, "netRevenue": 0, "students": 0 } }
}


Import/Export (admin)
POST /api/payments/import-csv  (admin)
-- Writes to live tables: payments and students.
- Body:
{
  "csv": "enrollment_number,student_name,intake_year,associate_wise_installments,zone,source_of_student,category,total_amount,Installment_number,installment_date,payment_type,amount,payment_recieved_in,payment_send_from,purpose,remarks,ak_approval,ak_remarks,installment_remarks,accounting_remarks\n..."
}
- Processing rules:
  - Trims leading # from enrollment_number when matching students.
  - Finds or creates student by enrollment_number.
  - Updates student attributes if present: student_name->name, intake_year, associate_wise_installments, zone, source_of_student, category, total_amount.
  - Before creating a payment, checks for duplicate by (student_id, payment_type, installment_number). If found, skips.

  - Each inserted payment updates student rollups (recieved_amount/total_payout_amount/net_amount) in students.

- Required columns (case-insensitive; supports Installment_number or installment_number):
  - enrollment_number, amount, payment_type, installment_number, installment_date
- Optional columns:
  - student_name, intake_year, associate_wise_installments, zone, source_of_student, category, total_amount,

  - payment_recieved_in, payment_send_from, purpose, remarks, ak_approval, ak_remarks, installment_remarks, accounting_remarks

- 200:
{ "inserted": 5, "failed": 1, "errors": [ { "rowNumber": 4, "message": "Invalid amount" } ] }

GET /api/payments/export-csv  (admin)

-- Reads from live payments table.
- Query (optional): student_id, created_from, created_to
- 200: CSV file download named "alzatoExport.csv" with headers:
  id,student_id,installment_date,amount,installment_number,payment_recieved_in,payment_type,remarks,purpose,ak_approval,ak_remarks,installment_remarks,accounting_remarks,payment_send_from,created_at


GET /api/payments/sample-csv  (admin)
- Downloads the sample CSV stored in the repository under src/sample.
- 200: attachment "alzato-sample-import-export.csv" containing the header and a few example rows.
